"use strict";var Tour=require("./../models/tourModel"),APIFeatures=require("./../utils/apiFeatures");exports.aliasTopTours=function(t,e,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:t.query.limit="5",t.query.sort="-ratingsAverage,price",t.query.fields="name,price,ratingsAverage,summary,difficulty",r();case 4:case"end":return e.stop()}})},exports.getAllTours=function(t,r){var s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=new APIFeatures(Tour.find(),t.query).filter().sort().limitFields().paginate(),e.next=4,regeneratorRuntime.awrap(s.query);case 4:a=e.sent,r.status(200).json({status:"success",requestedAt:t.requestTime,results:a.length,data:{tours:a}}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),r.status(400).json({status:"fail",message:e.t0});case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.getTour=function(t,r){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Tour.findById(t.params.id));case 3:s=e.sent,r.status(200).json({status:"success",data:{tour:s}}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(400).json({status:"fail",message:e.t0});case 10:case"end":return e.stop()}},null,null,[[0,7]])},exports.createTour=function(t,r){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Tour.create(t.body));case 3:s=e.sent,r.status(201).json({status:"success",requestedAt:t.requestTime,data:{tour:s}}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(400).json({status:"fail",message:"".concat(e.t0," ðŸ˜…")});case 10:case"end":return e.stop()}},null,null,[[0,7]])},exports.updateTour=function(t,r){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Tour.findByIdAndUpdate(t.params.id,t.body,{new:!0,runValidators:!0}));case 3:s=e.sent,r.status(200).json({status:"success",data:{tour:s}}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(404).json({status:"fail",message:e.t0});case 10:case"end":return e.stop()}},null,null,[[0,7]])},exports.deleteTour=function(t,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Tour.findByIdAndDelete(t.params.id));case 3:r.status(200).json({status:"success",requestedAt:t.requestTime,data:null}),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),r.status(404).json({status:"fail",message:e.t0});case 9:case"end":return e.stop()}},null,null,[[0,6]])},exports.getTourStats=function(e,t){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Tour.aggregate([{$match:{ratingsAverage:{$gte:4.5}}},{$group:{_id:{$toUpper:"$difficulty"},num:{$sum:1},numRatings:{$sum:"$ratingsQuantity"},avgRating:{$avg:"$ratingsAverage"},avgPrice:{$avg:"$price"},minPrice:{$min:"$price"},maxPrice:{$max:"$price"}}},{$sort:{avgPrice:1}}]));case 3:r=e.sent,t.status(200).json({status:"success",data:{stats:r}}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),t.status(404).json({status:"fail",message:e.t0});case 10:case"end":return e.stop()}},null,null,[[0,7]])},exports.getMonthlyPlan=function(t,r){var s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=1*t.params.year,e.next=4,regeneratorRuntime.awrap(Tour.aggregate([{$unwind:"$startDates"},{$match:{startDates:{$gte:new Date("".concat(s,"-01-01")),$lte:new Date("".concat(s,"-12-31"))}}},{$group:{_id:{$month:"$startDates"},numTourStarts:{$sum:1},tours:{$push:"$name"}}},{$addFields:{month:"$_id"}},{$project:{_id:0}},{$sort:{numTourStarts:-1}}]));case 4:a=e.sent,r.status(200).json({status:"success",data:{plan:a}}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),r.status(404).json({status:"fail",message:e.t0});case 11:case"end":return e.stop()}},null,null,[[0,8]])};